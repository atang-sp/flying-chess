<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飞行棋配置导出功能测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .test-section {
            margin-bottom: 40px;
            padding: 30px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
        }

        .test-section h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-demo {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .config-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .option-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .option-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .option-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .option-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #3b82f6;
        }

        .option-icon {
            font-size: 1.5rem;
        }

        .option-title {
            font-weight: 600;
            color: #1f2937;
        }

        .option-desc {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .stats-panel {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e40af;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .export-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 20px;
        }

        .export-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-panel {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result-panel.show {
            display: block;
        }

        .result-panel.error {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .json-preview {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }
            
            .content {
                padding: 20px;
            }
            
            .config-options {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎲 飞行棋配置导出测试</h1>
            <p>测试配置导出功能的完整流程</p>
        </div>

        <div class="content">
            <div class="test-section">
                <h2>📤 配置导出演示</h2>
                <div class="export-demo">
                    <p style="margin-bottom: 20px; color: #6b7280;">选择要导出的配置项，然后点击导出按钮测试功能：</p>
                    
                    <div class="config-options">
                        <div class="option-card" onclick="toggleOption('playerSettings')">
                            <div class="option-header">
                                <input type="checkbox" class="option-checkbox" id="playerSettings" checked>
                                <span class="option-icon">👥</span>
                                <span class="option-title">玩家设置</span>
                            </div>
                            <div class="option-desc">玩家数量和姓名配置</div>
                        </div>

                        <div class="option-card" onclick="toggleOption('punishmentConfig')">
                            <div class="option-header">
                                <input type="checkbox" class="option-checkbox" id="punishmentConfig" checked>
                                <span class="option-icon">⚙️</span>
                                <span class="option-title">惩罚设置</span>
                            </div>
                            <div class="option-desc">工具、部位、姿势等配置</div>
                        </div>

                        <div class="option-card" onclick="toggleOption('boardConfig')">
                            <div class="option-header">
                                <input type="checkbox" class="option-checkbox" id="boardConfig" checked>
                                <span class="option-icon">🎯</span>
                                <span class="option-title">棋盘设置</span>
                            </div>
                            <div class="option-desc">各种格子数量配置</div>
                        </div>

                        <div class="option-card" onclick="toggleOption('trapConfig')">
                            <div class="option-header">
                                <input type="checkbox" class="option-checkbox" id="trapConfig" checked>
                                <span class="option-icon">🔧</span>
                                <span class="option-title">机关设置</span>
                            </div>
                            <div class="option-desc">机关格子配置</div>
                        </div>

                        <div class="option-card" onclick="toggleOption('boardContent')">
                            <div class="option-header">
                                <input type="checkbox" class="option-checkbox" id="boardContent">
                                <span class="option-icon">🎲</span>
                                <span class="option-title">棋盘布局</span>
                            </div>
                            <div class="option-desc">完整棋盘布局（含随机种子）</div>
                        </div>
                    </div>

                    <div class="stats-panel">
                        <h3 style="margin-bottom: 15px; color: #1e40af;">📊 导出统计</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="itemCount">4</div>
                                <div class="stat-label">配置项数量</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="fileSize">2.1 KB</div>
                                <div class="stat-label">预估文件大小</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="qrSize">2.7 KB</div>
                                <div class="stat-label">二维码大小</div>
                            </div>
                        </div>
                    </div>

                    <button class="export-btn" onclick="performExport()">
                        📤 导出 JSON 文件
                    </button>

                    <div class="result-panel" id="resultPanel">
                        <h4 style="margin-bottom: 10px;">✅ 导出成功！</h4>
                        <p id="resultMessage">配置文件已生成并下载</p>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="showJsonPreview()">👁️ 预览 JSON</button>
                            <button class="btn btn-success" onclick="downloadAgain()">💾 重新下载</button>
                        </div>
                        <div class="json-preview" id="jsonPreview" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="test-section">
                <h2>🧪 功能测试指南</h2>
                <ol style="line-height: 1.8; color: #374151;">
                    <li><strong>选择配置项：</strong>点击上方的配置卡片来选择/取消选择要导出的内容</li>
                    <li><strong>查看统计：</strong>观察统计面板中的数据变化</li>
                    <li><strong>执行导出：</strong>点击"导出 JSON 文件"按钮</li>
                    <li><strong>验证结果：</strong>检查下载的文件内容是否正确</li>
                    <li><strong>预览功能：</strong>使用"预览 JSON"查看导出数据结构</li>
                </ol>
            </div>

            <div class="test-section">
                <h2>📋 测试检查清单</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                        <input type="checkbox" style="width: 18px; height: 18px;">
                        <span>配置项选择功能正常</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                        <input type="checkbox" style="width: 18px; height: 18px;">
                        <span>统计信息实时更新</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                        <input type="checkbox" style="width: 18px; height: 18px;">
                        <span>文件下载功能正常</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                        <input type="checkbox" style="width: 18px; height: 18px;">
                        <span>JSON格式正确</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                        <input type="checkbox" style="width: 18px; height: 18px;">
                        <span>文件名包含时间戳</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                        <input type="checkbox" style="width: 18px; height: 18px;">
                        <span>数据内容完整</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 模拟配置数据
        const mockData = {
            playerSettings: {
                playerCount: 2,
                playerNames: ["玩家1", "玩家2"]
            },
            punishmentConfig: {
                tools: [
                    { id: 'hand', name: '手掌', intensity: 2, ratio: 30 },
                    { id: 'ruler', name: '尺子', intensity: 3, ratio: 25 },
                    { id: 'cane', name: '藤条', intensity: 4, ratio: 20 }
                ],
                bodyParts: [
                    { id: 'butt', name: '屁股', sensitivity: 10, ratio: 80 },
                    { id: 'back', name: '后背', sensitivity: 7, ratio: 10 },
                    { id: 'thighs', name: '大腿', sensitivity: 5, ratio: 10 }
                ],
                positions: [
                    { id: 'standing', name: '站立', ratio: 25 },
                    { id: 'wall_lean', name: '手扶墙', ratio: 25 },
                    { id: 'table_lean', name: '趴在桌子上', ratio: 25 },
                    { id: 'kneeling', name: '跪趴', ratio: 25 }
                ],
                minStrikes: 10,
                maxStrikes: 30,
                step: 5,
                maxTakeoffFailures: 5
            },
            boardConfig: {
                punishmentCells: 28,
                bonusCells: 1,
                reverseCells: 2,
                restCells: 1,
                restartCells: 4,
                trapCells: 2,
                totalCells: 40
            },
            trapConfig: [
                {
                    id: 'trap_1',
                    name: '晾臀机关',
                    description: '晾臀5分钟'
                },
                {
                    id: 'trap_2',
                    name: '随机惩罚机关',
                    description: '由上一个被惩罚的玩家使用任意工具惩罚屁股'
                }
            ],
            boardContent: {
                seed: "abc123def456",
                board: Array.from({length: 40}, (_, i) => ({
                    id: i + 1,
                    type: i === 0 ? 'bonus' : (i % 5 === 0 ? 'special' : 'punishment'),
                    position: i + 1,
                    effect: {
                        type: i === 0 ? 'move' : 'punishment',
                        value: i === 0 ? 0 : 1,
                        description: i === 0 ? '起点' : '惩罚格子'
                    }
                })),
                generatedAt: Date.now()
            }
        };

        let currentExportData = null;

        // 获取当前选择的选项
        function getSelectedOptions() {
            return {
                playerSettings: document.getElementById('playerSettings').checked,
                punishmentConfig: document.getElementById('punishmentConfig').checked,
                boardConfig: document.getElementById('boardConfig').checked,
                trapConfig: document.getElementById('trapConfig').checked,
                boardContent: document.getElementById('boardContent').checked
            };
        }

        // 切换选项
        function toggleOption(optionId) {
            const checkbox = document.getElementById(optionId);
            checkbox.checked = !checkbox.checked;
            updateOptionCard(optionId);
            updateStats();
        }

        // 更新选项卡片样式
        function updateOptionCard(optionId) {
            const checkbox = document.getElementById(optionId);
            const card = checkbox.closest('.option-card');
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        // 更新统计信息
        function updateStats() {
            const options = getSelectedOptions();
            const selectedCount = Object.values(options).filter(Boolean).length;
            
            // 模拟计算文件大小
            let estimatedSize = 500; // 基础大小
            if (options.playerSettings) estimatedSize += 200;
            if (options.punishmentConfig) estimatedSize += 800;
            if (options.boardConfig) estimatedSize += 300;
            if (options.trapConfig) estimatedSize += 400;
            if (options.boardContent) estimatedSize += 2000;

            document.getElementById('itemCount').textContent = selectedCount;
            document.getElementById('fileSize').textContent = (estimatedSize / 1024).toFixed(1) + ' KB';
            document.getElementById('qrSize').textContent = (estimatedSize * 1.3 / 1024).toFixed(1) + ' KB';
        }

        // 生成导出数据
        function generateExportData(options) {
            const data = {
                version: "1.0.0",
                exportedAt: new Date().toISOString(),
                gameTitle: "飞行棋配置",
                description: "游戏配置导出文件",
                data: {}
            };

            if (options.playerSettings) data.data.playerSettings = mockData.playerSettings;
            if (options.punishmentConfig) data.data.punishmentConfig = mockData.punishmentConfig;
            if (options.boardConfig) data.data.boardConfig = mockData.boardConfig;
            if (options.trapConfig) data.data.trapConfig = mockData.trapConfig;
            if (options.boardContent) data.data.boardContent = mockData.boardContent;

            return data;
        }

        // 生成文件名
        function generateFilename(options) {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            const parts = [];
            
            if (options.playerSettings) parts.push('玩家');
            if (options.punishmentConfig) parts.push('惩罚');
            if (options.boardConfig) parts.push('棋盘');
            if (options.trapConfig) parts.push('机关');
            if (options.boardContent) parts.push('布局');
            
            const configType = parts.length > 0 ? parts.join('-') : '配置';
            return `飞行棋-${configType}-${timestamp}.json`;
        }

        // 执行导出
        function performExport() {
            const options = getSelectedOptions();
            const selectedCount = Object.values(options).filter(Boolean).length;
            
            if (selectedCount === 0) {
                alert('请至少选择一个配置项！');
                return;
            }

            try {
                const exportData = generateExportData(options);
                const filename = generateFilename(options);
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // 创建下载
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // 保存当前导出数据
                currentExportData = { data: exportData, filename };

                // 显示成功结果
                showResult(true, `文件 "${filename}" 已成功下载！`);
                
            } catch (error) {
                showResult(false, `导出失败: ${error.message}`);
            }
        }

        // 显示结果
        function showResult(success, message) {
            const panel = document.getElementById('resultPanel');
            const messageEl = document.getElementById('resultMessage');
            
            panel.className = 'result-panel show' + (success ? '' : ' error');
            messageEl.textContent = message;
            
            if (success) {
                panel.querySelector('h4').textContent = '✅ 导出成功！';
            } else {
                panel.querySelector('h4').textContent = '❌ 导出失败！';
            }
        }

        // 显示JSON预览
        function showJsonPreview() {
            if (!currentExportData) return;
            
            const preview = document.getElementById('jsonPreview');
            const jsonString = JSON.stringify(currentExportData.data, null, 2);
            preview.textContent = jsonString;
            preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
        }

        // 重新下载
        function downloadAgain() {
            if (!currentExportData) return;
            
            const jsonString = JSON.stringify(currentExportData.data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = currentExportData.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化选项卡片样式
            ['playerSettings', 'punishmentConfig', 'boardConfig', 'trapConfig'].forEach(updateOptionCard);
            updateStats();
        });
    </script>
</body>
</html>
