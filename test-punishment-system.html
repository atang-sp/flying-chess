<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>惩罚系统测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .combination {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .strikes {
            color: #dc3545;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 惩罚系统测试</h1>
        <p>测试新的惩罚系统逻辑：惩罚组合定义与惩罚数量分离</p>

        <div class="test-section">
            <div class="test-title">测试1：生成惩罚组合定义（不包含次数）</div>
            <button onclick="testCombinationDefinitions()">生成组合定义</button>
            <div id="combinations-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">测试2：从组合定义生成带次数的惩罚动作</div>
            <button onclick="testPunishmentActions()">生成惩罚动作</button>
            <div id="actions-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">测试3：验证同一组合可以有不同次数</div>
            <button onclick="testDifferentStrikes()">测试不同次数</button>
            <div id="strikes-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script type="module">
        // 模拟惩罚配置
        const mockConfig = {
            tools: [
                { id: 'hand', name: '手掌', intensity: 2, ratio: 50 },
                { id: 'ruler', name: '尺子', intensity: 4, ratio: 30 }
            ],
            bodyParts: [
                { id: 'butt', name: '屁股', sensitivity: 5, ratio: 60 },
                { id: 'palm', name: '手心', sensitivity: 3, ratio: 40 }
            ],
            positions: [
                { id: 'standing', name: '站立', ratio: 50 },
                { id: 'bending', name: '弯腰', ratio: 50 }
            ],
            minStrikes: 10,
            maxStrikes: 30,
            step: 5
        };

        // 模拟GameService的方法
        class MockGameService {
            static createPunishmentCombinationDefinition(tool, bodyPart, position) {
                return {
                    tool,
                    bodyPart,
                    position,
                    description: `用${tool.name}打${bodyPart.name}，姿势：${position.name}`
                };
            }

            static createPunishmentActionFromCombination(combination, config) {
                const minStrikes = Math.max(1, config.minStrikes || 10);
                const maxStrikes = Math.max(minStrikes, config.maxStrikes || 30);
                const step = config.step || 5;

                const minMultiple = Math.ceil(minStrikes / step);
                const maxMultiple = Math.floor(maxStrikes / step);

                const randomMultiple = Math.floor(Math.random() * (maxMultiple - minMultiple + 1)) + minMultiple;
                const strikes = randomMultiple * step;

                return {
                    tool: combination.tool,
                    bodyPart: combination.bodyPart,
                    position: combination.position,
                    strikes,
                    description: `用${combination.tool.name}打${combination.bodyPart.name}${strikes}下，姿势：${combination.position.name}`
                };
            }

            static generateBalancedPunishmentCombinationDefinitions(config, count = 4) {
                const combinations = [];
                const validTools = config.tools.filter(tool => tool.ratio > 0);
                const validBodyParts = config.bodyParts.filter(bodyPart => bodyPart.ratio > 0);
                const validPositions = config.positions.filter(position => position.ratio > 0);

                for (let i = 0; i < count && i < validTools.length * validBodyParts.length * validPositions.length; i++) {
                    const tool = validTools[i % validTools.length];
                    const bodyPart = validBodyParts[Math.floor(i / validTools.length) % validBodyParts.length];
                    const position = validPositions[Math.floor(i / (validTools.length * validBodyParts.length)) % validPositions.length];
                    
                    if (tool.intensity <= bodyPart.sensitivity) {
                        combinations.push(this.createPunishmentCombinationDefinition(tool, bodyPart, position));
                    }
                }

                return combinations;
            }
        }

        // 测试函数
        window.testCombinationDefinitions = function() {
            const combinations = MockGameService.generateBalancedPunishmentCombinationDefinitions(mockConfig, 4);
            const resultDiv = document.getElementById('combinations-result');
            
            let html = '<h4>生成的惩罚组合定义：</h4>';
            combinations.forEach((combo, index) => {
                html += `<div class="combination">
                    <strong>#${index + 1}</strong>: ${combo.description}
                    <br><small>工具: ${combo.tool.name} (强度${combo.tool.intensity}) | 部位: ${combo.bodyPart.name} (耐受度${combo.bodyPart.sensitivity}) | 姿势: ${combo.position.name}</small>
                </div>`;
            });
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        };

        window.testPunishmentActions = function() {
            const combinations = MockGameService.generateBalancedPunishmentCombinationDefinitions(mockConfig, 4);
            const resultDiv = document.getElementById('actions-result');
            
            let html = '<h4>从组合定义生成的惩罚动作：</h4>';
            combinations.forEach((combo, index) => {
                const action = MockGameService.createPunishmentActionFromCombination(combo, mockConfig);
                html += `<div class="combination">
                    <strong>#${index + 1}</strong>: ${action.description}
                    <br><small>次数: <span class="strikes">${action.strikes}下</span></small>
                </div>`;
            });
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        };

        window.testDifferentStrikes = function() {
            const combination = MockGameService.createPunishmentCombinationDefinition(
                mockConfig.tools[0], 
                mockConfig.bodyParts[0], 
                mockConfig.positions[0]
            );
            
            const resultDiv = document.getElementById('strikes-result');
            
            let html = `<h4>同一组合生成的不同次数：</h4>`;
            html += `<p><strong>组合定义</strong>: ${combination.description}</p>`;
            html += `<p><strong>生成的不同次数</strong>:</p>`;
            
            for (let i = 0; i < 10; i++) {
                const action = MockGameService.createPunishmentActionFromCombination(combination, mockConfig);
                html += `<div class="combination">
                    第${i + 1}次生成: <span class="strikes">${action.strikes}下</span> - ${action.description}
                </div>`;
            }
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        };
    </script>
</body>
</html>
